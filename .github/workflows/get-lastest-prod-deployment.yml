name: Get Latest Successful Deployment Ref for Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment to query (e.g., production, staging)'
        required: true
        default: 'production'
      wait_timeout_minutes:
        description: 'Maximum minutes to wait for an in-progress deployment to complete'
        required: false
        default: '300' # Default wait up to 5 minutes
      poll_interval_seconds:
        description: 'How often to poll status of in-progress deployment'
        required: false
        default: '10' # Poll every 10 seconds

jobs:
  find_successful_deployment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: read # Necessary to read deployment and deployment status data
  
    outputs:
      successful_deployment_ref: ${{ steps.find_deploy.outputs.successful_deployment_ref }}
      successful_deployment_id: ${{ steps.find_deploy.outputs.successful_deployment_id }}
      successful_deployment_url: ${{ steps.find_deploy.outputs.successful_deployment_url }}
  
    steps:
      - name: Checkout repository (optional, but good practice)
        uses: actions/checkout@v4

      - name: Find Latest Successful Deployment
        id: find_deploy
        uses: ./.github/actions/get-latest-successful-deployment

      - name: Display Deployment Ref
        run: |
          echo "${{ steps.find_deploy.outputs.successful_deployment_ref }}"